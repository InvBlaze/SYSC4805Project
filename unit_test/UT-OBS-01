/* UT-OBS-01 — Ultrasonic accuracy & classification
   Checks median distance at 5, 10, 20, 30 cm and average abs error <= 1.5 cm.
   Also prints class: CLEAR / CUBE (low only) / TALL (high or both).
   Pins: LOW TRIG=22 ECHO=23, HIGH TRIG=24 ECHO=25. */

#define US_LOW_TRIG   22
#define US_LOW_ECHO   23
#define US_HIGH_TRIG  24
#define US_HIGH_ECHO  25

const unsigned long US_TO_US=24000;

static inline void pulseTrig(int pin){ digitalWrite(pin,LOW); delayMicroseconds(2); digitalWrite(pin,HIGH); delayMicroseconds(10); digitalWrite(pin,LOW); }
static float readUS(int t,int e){ pulseTrig(t); unsigned long d=pulseIn(e,HIGH,US_TO_US); return d? d*0.0343f*0.5f: 10000.0f; }

float median25(float* a){
  for(int i=0;i<25;i++) for(int j=i+1;j<25;j++) if(a[j]<a[i]){ float tmp=a[i]; a[i]=a[j]; a[j]=tmp; }
  return a[12];
}

void setup(){
  Serial.begin(115200);
  pinMode(US_LOW_TRIG,OUTPUT);  pinMode(US_LOW_ECHO,INPUT);
  pinMode(US_HIGH_TRIG,OUTPUT); pinMode(US_HIGH_ECHO,INPUT);
  Serial.println("===== UT-OBS-01 =====");
  Serial.println("Use a flat target at 5, 10, 20, 30 cm (tape measure). Keep steady during each prompt.");
}

void loop(){
  bool ok=true; float sumErr=0; int nPts=0;

  int targets[4]={5,10,20,30};
  for(int k=0;k<4;k++){
    int cm = targets[k];
    Serial.print("Hold target at ~"); Serial.print(cm); Serial.println(" cm and press ENTER.");
    while(!Serial.available()){}
    while(Serial.available()) Serial.read();
    float L[25], H[25];
    for(int i=0;i<25;i++){ L[i]=readUS(US_LOW_TRIG,US_LOW_ECHO); H[i]=readUS(US_HIGH_TRIG,US_HIGH_ECHO); delay(25); }
    float low_m  = median25(L);
    float high_m = median25(H);
    float eL = (low_m<9000)? fabs(low_m - cm) : 999;
    float eH = (high_m<9000)? fabs(high_m - cm): 999;
    float e  = min(eL,eH);
    if(e<900) { sumErr+=e; nPts++; }

    const char* cls = (low_m<9000 && high_m>9000) ? "CUBE" :
                      (high_m<9000)                ? "TALL" :
                                                     "CLEAR";
    Serial.print("low="); Serial.print(low_m,1); Serial.print(" cm, high="); Serial.print(high_m,1);
    Serial.print(" cm, best error="); Serial.print(e,2); Serial.print(" cm, class="); Serial.println(cls);
  }

  float avgErr = nPts? sumErr/nPts : 999;
  Serial.print("Average abs error ≈ "); Serial.print(avgErr,2); Serial.println(" cm");
  if(!(avgErr <= 1.5f)){ Serial.println("[FAIL] Average error > 1.5 cm"); ok=false; }

  Serial.print("[SUMMARY] UT-OBS-01 -> "); Serial.println(ok? "PASS":"FAIL");
  while(true) delay(250);
}
