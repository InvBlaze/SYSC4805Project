/* UT-IMU-01 — IMU LSM6DS33 on I2C
   Pass if WHO_AM_I reads 0x69 and gyro bytes stream.
   Wiring (Due 3.3V): VIN->3.3V, GND->GND, SDA->SDA, SCL->SCL. */

#include <Wire.h>
#define ASSERT_OK(c,msg) do{ if(!(c)){ Serial.print("[FAIL] "); Serial.println(msg); ok=false; } }while(0)
void hdr(const char* t){ Serial.println(); Serial.print("===== "); Serial.print(t); Serial.println(" ====="); }

#define LSM6_ADDR_PRIMARY 0x6B
#define LSM6_ADDR_ALT     0x6A
#define LSM6_REG_WHOAMI   0x0F
#define LSM6_WHOAMI_VAL   0x69
#define LSM6_CTRL1_XL     0x10
#define LSM6_CTRL2_G      0x11
#define LSM6_CTRL3_C      0x12
#define LSM6_OUTX_L_G     0x22
const float GYRO_DPS_PER_LSB = 0.00875f;

uint8_t IMU_ADDR=0;
bool i2cReadN(uint8_t a,uint8_t r,uint8_t n,uint8_t*b){
  Wire.beginTransmission(a); Wire.write(r);
  if(Wire.endTransmission(false)) return false;
  if(Wire.requestFrom(a,n)!=n) return false;
  for(uint8_t i=0;i<n;i++) b[i]=Wire.read(); return true;
}
void i2cWrite8(uint8_t a,uint8_t r,uint8_t v){ Wire.beginTransmission(a); Wire.write(r); Wire.write(v); Wire.endTransmission(true); }

void setup(){
  Serial.begin(115200); hdr("UT-IMU-01");
  Wire.begin(); delay(5);
  bool ok=true;

  uint8_t who=0;
  if(i2cReadN(LSM6_ADDR_PRIMARY, LSM6_REG_WHOAMI, 1, &who) && who==LSM6_WHOAMI_VAL) IMU_ADDR=LSM6_ADDR_PRIMARY;
  else if(i2cReadN(LSM6_ADDR_ALT, LSM6_REG_WHOAMI, 1, &who) && who==LSM6_WHOAMI_VAL) IMU_ADDR=LSM6_ADDR_ALT;

  Serial.print("WHO_AM_I = 0x"); Serial.println(who,HEX);
  ASSERT_OK(IMU_ADDR!=0, "IMU not detected");

  if(IMU_ADDR){
    i2cWrite8(IMU_ADDR, LSM6_CTRL3_C, 0x44); 
    i2cWrite8(IMU_ADDR, LSM6_CTRL1_XL, 0x40); 
    i2cWrite8(IMU_ADDR, LSM6_CTRL2_G,  0x40);
    delay(40);


    uint8_t b[6]; int samples=0; float maxAbs=0;
    unsigned long t0=millis();
    while(millis()-t0<800){
      if(i2cReadN(IMU_ADDR, LSM6_OUTX_L_G, 6, b)){
        int16_t gz=(int16_t)(b[5]<<8 | b[4]);
        float gz_dps=gz*GYRO_DPS_PER_LSB;
        if(fabs(gz_dps)>maxAbs) maxAbs=fabs(gz_dps);
        samples++;
      }
      delay(5);
    }
    Serial.print("Gyro samples="); Serial.print(samples);
    Serial.print(", max|gz|≈"); Serial.print(maxAbs,1); Serial.println(" dps");
    ASSERT_OK(samples>=20, "Gyro not readable");
  }
  Serial.print("[SUMMARY] UT-IMU-01 -> "); Serial.println(ok? "PASS":"FAIL");
}

void loop(){ while(true) delay(250); }
