// === æ¨¡æ‹Ÿè¾“å…¥å¼•è„š ===
#define L A0
#define M A1
#define R A2

// === ç”µæœºé©±åŠ¨å¼•è„š ===
#define M1_PWM 2
#define M1_DIR 3
#define M2_PWM 4
#define M2_DIR 5
#define M3_PWM 6
#define M3_DIR 7
#define M4_PWM 8
#define M4_DIR 9

// === å‚æ•°è®¾ç½® ===
int TH_L = 900;     // å·¦æ¢å¤´é»‘ç™½é˜ˆå€¼
int TH_M = 900;     // ä¸­æ¢å¤´é»‘ç™½é˜ˆå€¼
int TH_R = 900;     // å³æ¢å¤´é»‘ç™½é˜ˆå€¼
int BASE_SPEED = 80;    // å‰è¿›é€Ÿåº¦ï¼ˆæ…¢é€Ÿï¼‰
int TURN_SPEED = 70;    // è½¬å‘é€Ÿåº¦
int BACK_TIME = 150;    // ç¢°çº¿ååé€€æ—¶é—´ (ms)
int TURN_TIME = 400;    // è½¬å‘æ—¶é—´ (ms)

// === åˆå§‹åŒ– ===
void setup() {
  Serial.begin(115200);
  Serial.println("=== Analog Black-Line Avoidance Car ===");

  pinMode(M1_PWM, OUTPUT); pinMode(M1_DIR, OUTPUT);
  pinMode(M2_PWM, OUTPUT); pinMode(M2_DIR, OUTPUT);
  pinMode(M3_PWM, OUTPUT); pinMode(M3_DIR, OUTPUT);
  pinMode(M4_PWM, OUTPUT); pinMode(M4_DIR, OUTPUT);

  stopMotors();
  delay(500);
  Serial.println("Ready!");
}

// === ä¸»å¾ªç¯ ===
void loop() {
  int Lval = analogRead(L);
  int Mval = analogRead(M);
  int Rval = analogRead(R);

  bool L_black = (Lval > TH_L);
  bool M_black = (Mval > TH_M);
  bool R_black = (Rval > TH_R);

  Serial.print("L="); Serial.print(Lval);
  Serial.print(" M="); Serial.print(Mval);
  Serial.print(" R="); Serial.print(Rval);
  Serial.print("  ->  ");
  if (L_black || M_black || R_black) Serial.println("ğŸ–¤ BLACK DETECTED");
  else Serial.println("â¬œ WHITE FLOOR");

  // ç™½åœ°ï¼šæ­£å¸¸å‰è¿›
  if (!L_black && !M_black && !R_black) {
    forward(BASE_SPEED);
  }
  // æ£€æµ‹åˆ°é»‘çº¿ï¼šåé€€ + è½¬å‘
  else {
    stopMotors(); delay(100);
    backward(BASE_SPEED); delay(BACK_TIME);
    stopMotors(); delay(100);

    if (L_black && !R_black) {
      // å·¦è¾¹æ’çº¿ â†’ å‘å³è½¬
      turnRight(TURN_SPEED);
      delay(TURN_TIME);
    } 
    else if (R_black && !L_black) {
      // å³è¾¹æ’çº¿ â†’ å‘å·¦è½¬
      turnLeft(TURN_SPEED);
      delay(TURN_TIME);
    } 
    else {
      // ä¸­é—´æˆ–ä¸¤è¾¹ä¸€èµ·é»‘ â†’ é»˜è®¤å³è½¬
      turnRight(TURN_SPEED);
      delay(TURN_TIME);
    }
    stopMotors(); delay(100);
  }

  delay(20);
}

// === ç”µæœºæ§åˆ¶å‡½æ•° ===
void forward(int s) {
  digitalWrite(M1_DIR, LOW);
  digitalWrite(M3_DIR, LOW);
  digitalWrite(M2_DIR, HIGH);
  digitalWrite(M4_DIR, HIGH);
  analogWrite(M1_PWM, s);
  analogWrite(M2_PWM, s);
  analogWrite(M3_PWM, s);
  analogWrite(M4_PWM, s);
}

void backward(int s) {
  digitalWrite(M1_DIR, HIGH);
  digitalWrite(M3_DIR, HIGH);
  digitalWrite(M2_DIR, LOW);
  digitalWrite(M4_DIR, LOW);
  analogWrite(M1_PWM, s);
  analogWrite(M2_PWM, s);
  analogWrite(M3_PWM, s);
  analogWrite(M4_PWM, s);
}

void turnLeft(int s) {
  // å·¦è½®åã€å³è½®å‰ â†’ å·¦è½¬
  digitalWrite(M1_DIR, HIGH);
  digitalWrite(M3_DIR, HIGH);
  digitalWrite(M2_DIR, HIGH);
  digitalWrite(M4_DIR, HIGH);
  analogWrite(M1_PWM, s);
  analogWrite(M3_PWM, s);
  analogWrite(M2_PWM, s);
  analogWrite(M4_PWM, s);
}

void turnRight(int s) {
  // å·¦è½®å‰ã€å³è½®å â†’ å³è½¬
  digitalWrite(M1_DIR, LOW);
  digitalWrite(M3_DIR, LOW);
  digitalWrite(M2_DIR, LOW);
  digitalWrite(M4_DIR, LOW);
  analogWrite(M1_PWM, s);
  analogWrite(M3_PWM, s);
  analogWrite(M2_PWM, s);
  analogWrite(M4_PWM, s);
}

void stopMotors() {
  analogWrite(M1_PWM, 0);
  analogWrite(M2_PWM, 0);
  analogWrite(M3_PWM, 0);
  analogWrite(M4_PWM, 0);
}
